---
title: "Single-copy genes missing and present from Rumex xyy male haplotype assemblies and Rumex salicifolius"
output:
  rmdformats::html_clean:
    code_folding: show
    default_style: light
    toc_depth: 6
    fig_caption: yes
---

# data cleaning
Goal: obtain a list of 1-1 syntenic orthologs that are present in hap1 and sal, but not hap2 - as well as the opposite case. Particularly interested in the sex chromosomes.
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(vroom)
```

## raw files
Load in long-format pangenome databases for each reference
```{r echo=TRUE, message=FALSE}
hap1raw<-vroom("hap1_pangenes.txt", show_col_types = F)
hap2raw<-vroom("hap2_pangenes.txt",show_col_types=F)
salraw<-vroom("salicifolius_pangenes.txt", show_col_types=F)
```
What do these column names mean?

colname  |definition
---------|------
ofID | orthofinder-given unique gene ID
pgID | the unique position-by-orthogroup combination identifier. Each row in the pangenome-annotation is a unique value of this field
interpChr |  the chromosome (syntenic or actual) on the reference genome
interpOrd     | the gene-rank order position (interpolated or actual) on the reference genome
pgRepID     | the ofID for the representative gene for each pgID
genome    | genome of the focal gene (id column)
og   | orthogroup ID taken from the combBed.txt file
flag| specifies whether the gene is a syntenic ortholog (‘PASS’), non-syntenic ortholog, or array member.
id| bed-specified gene ID 
chr| chromosome
start| start pos
end | end pos
ord | gene rank order

### what do I need to do?
```{r}
hap1syn<- hap1raw %>% dplyr::filter(flag=="PASS")
hap2syn<-hap2raw %>% dplyr::filter(flag=="PASS")
salsyn<-salraw %>% dplyr::filter(flag=="PASS")
```
Determine which genes are present in haplotype 1 and present or absent in haplotype 2
Determine which genes are present in haplotype 2 and not presetn in absent in haplotype 1
Determine which genes are not shared by sal and the other two, or are only shared between sal and one or the other. 
### what will the data look like
Here I'm envisioning a table of shared positions and gene names (column separated by species. I can include a flag indication which don't have a syntenic ortholog. 
simplest candidate for Y gene loss: single copy syntenic hap1 and sal but not in hap2.
What is my ultimate question? 
Is there gene loss on Y? neo Y? 
### Gene loss on Y - Data wrangling

#### remove dups and combine to complete list
```{r}
hap1nodups_a<-hap1syn %>% filter(genome == "hap1") %>% distinct(pgID,.keep_all=TRUE) %>% select(id)
hap1nodups_b<- hap2syn %>%filter(genome == "hap1") %>% distinct(pgID,.keep_all=TRUE) %>% select(id)
hap1nodups_c<-salsyn %>%filter(genome == "hap1") %>% distinct(pgID,.keep_all=TRUE) %>% select(id)
hap1nodups<-union(hap1nodups_a,hap1nodups_b) 
hap1nodups<-union(hap1nodups,hap1nodups_c) 
##
hap2nodups_a<-hap1syn %>% filter(genome=="hap2") %>% distinct(pgID,.keep_all=TRUE) %>% select(id)
hap2nodups_b<-hap2syn %>%filter(genome == "hap2") %>% distinct(pgID,.keep_all=TRUE) %>% select(id)
hap2nodups_c<-salsyn %>%filter(genome == "hap2") %>% distinct(pgID,.keep_all=TRUE) %>% select(id)
hap2nodups<-union(hap2nodups_a,hap2nodups_b) 
hap2nodups<-union(hap2nodups,hap2nodups_c)
##
salnodups_a<-hap1syn %>% filter(genome=="salicifolius") %>% distinct(pgID,.keep_all=TRUE) %>% select(id)
salnodups_b<-hap2syn %>% filter(genome=="salicifolius") %>% distinct(pgID,.keep_all=TRUE) %>% select(id)
salnodups_c<-salsyn %>% filter(genome=="salicifolius") %>% distinct(pgID,.keep_all=TRUE) %>% select(id)
salnodups<-union(salnodups_a,salnodups_b) 
salnodups<-union(salnodups,salnodups_c)
###
```


#### Syntenic genes
Obtain a list of genes shared by hap1, sal, but NOT hap2
```{r}
## remove dups and get into wide format
hap1pg<-hap1syn %>%select(pgID,genome,id) %>%
  filter((id%in%salnodups$id | id%in%hap2nodups$id | id%in%hap1nodups$id)) %>%
  pivot_wider(names_from=genome, values_from=id,values_fn=list) %>% 
  mutate_all( ~replace(., lengths(.)==0, NA))
hap2pg <-hap2syn %>%select(pgID,genome,id) %>%
  filter((id%in%salnodups$id | id%in%hap2nodups$id | id%in%hap1nodups$id)) %>%
  pivot_wider(names_from=genome, values_from=id,values_fn=list) %>% 
  mutate_all( ~replace(., lengths(.)==0, NA))
salpg<- salsyn %>%select(pgID,genome,id) %>%
  filter((id%in%salnodups$id | id%in%hap2nodups$id | id%in%hap1nodups$id)) %>%
  pivot_wider(names_from=genome, values_from=id,values_fn=list) %>% 
  mutate_all( ~replace(., lengths(.)==0, NA))
##
df1<-hap1pg %>% filter(!is.na(hap1) & is.na(hap2) & !is.na(salicifolius)) %>% select(hap1)
df2<-hap2pg %>% filter(!is.na(hap1) & is.na(hap2) & !is.na(salicifolius)) %>% select(hap1)
df3<-salpg %>% filter(!is.na(hap1) & is.na(hap2) & !is.na(salicifolius)) %>% select(hap1)
## combined list
all_nohap2<-intersect(df1,df2)
all_nohap2<-intersect(all_nohap2,df3)
## THESE ARE THE GENES W SAL AND HAP1 BUT NO HAP2 equivs
```
#### connect to positions
```{r}
all_nohap2$hap1<- as.character(all_nohap2$hap1)
anno_pg<-inner_join(all_nohap2,hap1syn, by=c("hap1"="id"))
#write.csv(anno_pg, "hap1sal_nohap2.csv")
```
### Summary of gene list

#### summarising number of genes
```{r}
a<-anno_pg %>% group_by(interpChr) %>% summarise(n=n()) %>% 
  filter(interpChr== "A1"|interpChr=="A2"| interpChr=="A4" |interpChr=="X")

b<-hap1raw %>% filter(genome=="hap1") %>% group_by(interpChr) %>% summarise(n=n()) %>%
  filter(interpChr== "A1"|interpChr=="A2"| interpChr=="A4" |interpChr=="X")
# b<-hap1pg %>% filter(!is.na(hap1)) %>% group_by(interpChr) %>% summarise(n=n()) %>%
#   filter(interpChr== "A1"|interpChr=="A2"| interpChr=="A4" |interpChr=="X")
## ok what about the counts from the og bed file
bedbedbed<-vroom("hap1.bed", col_names = F)
c<-bedbedbed %>% rename(interpChr=X1) %>% group_by(.,interpChr) %>% summarise(n=n())  %>%
  filter(interpChr== "A1"|interpChr=="A2"| interpChr=="A4" |interpChr=="X")
```
#### How many genes are missing from theX compared to other chr?
What proportion of genes (wrt hap1 bed file) have a syntenic ortholog shared with Salicifolius but NOT hap2?
```{r proportion}
chrpropn<-full_join(c,a,by="interpChr",suffix=c(".total",".notonhap2")) %>% 
  mutate(., propn=n.notonhap2/n.total) %>% mutate(.,percent = propn*100)
## denominator might be off?
```
#### PARs and old and new sex-linked regions?
```{r}
anno_par <- anno_pg %>% mutate(region=if_else(interpChr =="X" & end<=71000000,"PAR1",
                        if_else(interpChr =="X" & (end>71000000 & end<=261000000),"OldX",
                        if_else(interpChr=="X" & (end>261000000 & end<=367000000),"NewX", 
                        if_else(interpChr=="X" & end>367000000,"PAR2",
                        if_else(interpChr=="A1","A1",
                        if_else(interpChr=="A2","A2",
                        if_else(interpChr=="A4","A4",NA))))))))
a<-anno_par %>% group_by(region) %>% summarise(n=n()) %>% 
  filter(!is.na(region))

bedfix<-bedbedbed %>% rename(interpChr=X1)%>% rename(end=X3) %>%
  mutate(.,region=if_else(interpChr =="X" &end<=71000000,"PAR1",
                        if_else(interpChr =="X" & (end>71000000 & end<=261000000),"OldX",
                        if_else(interpChr=="X" & (end>261000000 & end<=367000000),"NewX", 
                        if_else(interpChr=="X" & end>367000000,"PAR2",
                        if_else(interpChr=="A1","A1",
                        if_else(interpChr=="A2","A2",
                        if_else(interpChr=="A4","A4",NA))))))))

c<-bedfix %>% group_by(region) %>% summarise(n=n())  %>%
  filter(!is.na(region))
## keep only non dup genes
b<-bedfix%>% filter(X4%in%hap1nodups$id) %>% group_by(region) %>% summarise(n=n())  %>%
  filter(!is.na(region))
chrpropnPAR<-full_join(b,a,by="region",suffix=c(".total",".notonhap2")) %>% 
  mutate(., propn=n.notonhap2/n.total) %>% mutate(.,percent = propn*100)
```
#### results so far
genes missing from hap2 
```{r}
library(knitr)
kable(chrpropnPAR)
```



#### plotting
```{r}
#library(ggbio)
library(GenomicRanges)
library(GenomicFeatures)
library(rtracklayer)
library(tidyverse)
bedanno<-import("hap1.bed")
head(bedanno)

```



